#!/usr/bin/env zsh

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Valores padrão
DB_HOST="localhost"
DB_USER="postgres"
DUMP_FILE=""

# Parseamento de argumentos
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--host)
            DB_HOST="$2"
            shift 2
            ;;
        -u|--user)
            DB_USER="$2"
            shift 2
            ;;
        -f|--file)
            DUMP_FILE="$2"
            shift 2
            ;;
        *)
            echo -e "${RED}Erro: Opção desconhecida '$1'${NC}"
            echo "Uso: restore-database [-h HOST] [-u USER] -f ARQUIVO_DUMP"
            exit 1
            ;;
    esac
done

# Validar que o arquivo de dump foi fornecido
if [[ -z "$DUMP_FILE" ]]; then
    echo -e "${RED}Erro: O parâmetro -f é obrigatório${NC}"
    echo "Uso: restore-database [-h HOST] [-u USER] -f ARQUIVO_DUMP"
    exit 1
fi

# Validar que o arquivo existe
if [[ ! -f "$DUMP_FILE" ]]; then
    echo -e "${RED}Erro: O arquivo '$DUMP_FILE' não existe${NC}"
    exit 1
fi

# Validar que o arquivo é legível
if [[ ! -r "$DUMP_FILE" ]]; then
    echo -e "${RED}Erro: O arquivo '$DUMP_FILE' não pode ser lido${NC}"
    exit 1
fi

# Exibir configuração
echo -e "${BLUE}=== Script de Restore PostgreSQL ===${NC}"
echo -e "Host: ${GREEN}$DB_HOST${NC}"
echo -e "Usuário: ${GREEN}$DB_USER${NC}"
echo -e "Arquivo de dump: ${GREEN}$DUMP_FILE${NC}"
echo ""

# Pedir senha
echo -n "Senha do PostgreSQL: "
read -s DB_PASSWORD
echo ""
echo ""

# Exportar senha para uso com pg_dump/psql
export PGPASSWORD="$DB_PASSWORD"

# Testar conexão
echo -e "${YELLOW}Testando conexão com o banco de dados...${NC}"
if ! psql -h "$DB_HOST" -U "$DB_USER" -d "postgres" -c "SELECT 1;" &>/dev/null; then
    echo -e "${RED}Erro: Não foi possível conectar ao PostgreSQL${NC}"
    echo "Verifique:"
    echo "  - Host e usuário estão corretos"
    echo "  - Senha está correta"
    echo "  - Servidor PostgreSQL está acessível"
    unset PGPASSWORD
    exit 1
fi
echo -e "${GREEN}✓ Conexão estabelecida com sucesso${NC}"
echo ""

# Listar bancos de dados disponíveis
echo -e "${YELLOW}Listando bancos de dados disponíveis...${NC}"
echo ""

# Obter lista de bancos (excluindo system databases e o banco postgres)
DATABASES=$(psql -h "$DB_HOST" -U "$DB_USER" -d "postgres" -t -c \
    "SELECT datname FROM pg_database WHERE datistemplate = false AND datname != 'postgres' ORDER BY datname;" 2>/dev/null)

if [[ -z "$DATABASES" ]]; then
    echo -e "${RED}Erro: Não foram encontrados bancos de dados acessíveis${NC}"
    unset PGPASSWORD
    exit 1
fi

# Converter array e numerar bancos
i=1
declare -a DB_ARRAY
while IFS= read -r db; do
    if [[ -n "$db" ]]; then
        db=$(echo "$db" | xargs) # Remover espaços em branco
        echo -e "${BLUE}) $i${NC} - ${GREEN}$db${NC}"
        DB_ARRAY+=("$db")
        ((i++))
    fi
done <<< "$DATABASES"

echo -e "${BLUE}n${NC}) ${GREEN}Criar novo banco de dados${NC}"
echo ""
echo -n "Digite o número do banco ou 'n' para criar um novo: "
read DB_SELECTION

# Verificar se o usuário quer criar um novo banco
if [[ "$DB_SELECTION" =~ ^[nN]$ ]]; then
    # Criar novo banco
    echo ""
    echo -n "Digite o nome do novo banco de dados: "
    read NEW_DB_NAME
    
    # Validar nome do banco
    if [[ -z "$NEW_DB_NAME" ]]; then
        echo -e "${RED}Erro: Nome do banco não pode ser vazio${NC}"
        unset PGPASSWORD
        exit 1
    fi
    
    # Verificar se o nome começa com número (não permitido em PostgreSQL)
    if [[ "$NEW_DB_NAME" =~ ^[0-9] ]]; then
        echo -e "${RED}Erro: Nome do banco não pode começar com número${NC}"
        unset PGPASSWORD
        exit 1
    fi
    
    # Verificar se contém apenas caracteres válidos (letras, números, underscore)
    if [[ ! "$NEW_DB_NAME" =~ ^[a-zA-Z][a-zA-Z0-9_]*$ ]]; then
        echo -e "${RED}Erro: Nome do banco deve conter apenas letras, números e underscores, e não pode começar com número${NC}"
        unset PGPASSWORD
        exit 1
    fi
    
    # Verificar se o banco já existe
    DB_EXISTS=$(psql -h "$DB_HOST" -U "$DB_USER" -d "postgres" -t -c \
        "SELECT 1 FROM pg_database WHERE datname = '$NEW_DB_NAME';" 2>/dev/null | tr -d ' ')
    
    if [[ "$DB_EXISTS" == "1" ]]; then
        echo -e "${RED}Erro: O banco de dados '$NEW_DB_NAME' já existe${NC}"
        echo -e "${YELLOW}Por favor, selecione o banco existente da lista ou escolha outro nome${NC}"
        unset PGPASSWORD
        exit 1
    fi
    
    SELECTED_DB="$NEW_DB_NAME"
    echo -e "Novo banco: ${GREEN}$SELECTED_DB${NC}"
    echo ""
    
    # Para novo banco, não precisamos de confirmação de apagamento
    echo -e "${YELLOW}Criando banco de dados '$SELECTED_DB'...${NC}"
    if ! psql -h "$DB_HOST" -U "$DB_USER" -d "postgres" -c "CREATE DATABASE \"$SELECTED_DB\";" &>/dev/null; then
        echo -e "${RED}Erro ao criar banco de dados${NC}"
        unset PGPASSWORD
        exit 1
    fi
    echo -e "${GREEN}✓ Banco criado com sucesso${NC}"
    echo ""
else
    # Validar seleção de banco existente
    if ! [[ "$DB_SELECTION" =~ ^[0-9]+$ ]] || [[ "$DB_SELECTION" -lt 1 ]] || [[ "$DB_SELECTION" -gt ${#DB_ARRAY[@]} ]]; then
        echo -e "${RED}Erro: Seleção inválida${NC}"
        unset PGPASSWORD
        exit 1
    fi

    # Obter nome do banco selecionado
    SELECTED_DB="${DB_ARRAY[$DB_SELECTION]}"
    echo -e "Banco selecionado: ${GREEN}$SELECTED_DB${NC}"
    echo ""

    # Aviso de segurança
    echo -e "${RED}⚠️  AVISO IMPORTANTE ⚠️${NC}"
    echo -e "${RED}O banco de dados '$SELECTED_DB' será APAGADO COMPLETAMENTE e recriado.${NC}"
    echo -e "${RED}Todos os dados atuais serão perdidos permanentemente.${NC}"
    echo ""
    echo -n "Deseja continuar? (S/n): "
    read CONFIRMATION

    if [[ "$CONFIRMATION" == "n" || "$CONFIRMATION" == "N" ]]; then
        echo -e "${YELLOW}Operação cancelada pelo usuário${NC}"
        unset PGPASSWORD
        exit 0
    fi
    echo ""

    # Terminar conexões ativas no banco
    echo -e "${YELLOW}Encerrando conexões ativas no banco '$SELECTED_DB'...${NC}"
    psql -h "$DB_HOST" -U "$DB_USER" -d "postgres" -c \
        "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = '$SELECTED_DB' AND pid <> pg_backend_pid();" &>/dev/null

    # Drop database
    echo -e "${YELLOW}Apagando banco de dados '$SELECTED_DB'...${NC}"
    if ! psql -h "$DB_HOST" -U "$DB_USER" -d "postgres" -c "DROP DATABASE IF EXISTS \"$SELECTED_DB\";" &>/dev/null; then
        echo -e "${RED}Erro ao apagar banco de dados${NC}"
        unset PGPASSWORD
        exit 1
    fi
    echo -e "${GREEN}✓ Banco apagado com sucesso${NC}"

    # Create database
    echo -e "${YELLOW}Criando banco de dados '$SELECTED_DB'...${NC}"
    if ! psql -h "$DB_HOST" -U "$DB_USER" -d "postgres" -c "CREATE DATABASE \"$SELECTED_DB\";" &>/dev/null; then
        echo -e "${RED}Erro ao criar banco de dados${NC}"
        unset PGPASSWORD
        exit 1
    fi
    echo -e "${GREEN}✓ Banco criado com sucesso${NC}"
    echo ""
fi

# Restore do dump
echo -e "${YELLOW}Iniciando restore do banco '$SELECTED_DB'...${NC}"
echo "Arquivo de origem: $DUMP_FILE"
echo ""

if psql -h "$DB_HOST" -U "$DB_USER" -d "$SELECTED_DB" < "$DUMP_FILE" 2>&1; then
    echo ""
    echo -e "${GREEN}✓ Restore concluído com sucesso!${NC}"
    echo -e "Banco de dados restaurado: ${BLUE}$SELECTED_DB${NC}"
else
    echo ""
    echo -e "${RED}Erro ao realizar restore${NC}"
    unset PGPASSWORD
    exit 1
fi

# Limpar variável de ambiente
unset PGPASSWORD
